name: Android APK Build

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Grant execute permission for gradlew
      run: chmod +x ./gradlew
        
    - name: Build Debug APK
      shell: bash
      run: ./gradlew assembleDebug --no-daemon --stacktrace --info --warning-mode all
      
    - name: List Build Outputs
      if: always()
      shell: bash
      run: |
        echo "Listing build outputs..."
        ls -R app/build/outputs/ || true
      
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: n0tez-debug-apk
        path: app/build/outputs/apk/debug/app-debug.apk

    - name: Generate Temporary Keystore (CI only)
      shell: bash
      run: |
        keytool -genkey -v -keystore release.keystore -storepass android -keypass android -alias n0tez \
          -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=n0tez, OU=CI, O=n0tez, L=City, S=State, C=US"

    - name: Build Release APK (signed with temporary keystore)
      shell: bash
      env:
        N0TEZ_STORE_FILE: ${{ github.workspace }}/release.keystore
        N0TEZ_STORE_PASSWORD: android
        N0TEZ_KEY_ALIAS: n0tez
        N0TEZ_KEY_PASSWORD: android
      run: ./gradlew assembleRelease --no-daemon --stacktrace --info --warning-mode all
      
    - name: List Release Outputs
      if: always()
      shell: bash
      run: |
        echo "Listing release outputs..."
        ls -R app/build/outputs/apk/release/ || true

    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: n0tez-release-apk
        path: app/build/outputs/apk/release/app-release.apk
